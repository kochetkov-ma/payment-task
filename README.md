# –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —á–µ—Ä–µ–∑ Kafka.

## –ú–æ–¥—É–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞

- **payment-backend** (–ø–æ—Ä—Ç 8080) - API –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- **payment-balance-service** (–ø–æ—Ä—Ç 8081) - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ–º–∏—Å—Å–∏—è –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –≤ –∫–æ–¥–µ (1%)

## –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞

```bash
docker-compose up -d
```

–°–µ—Ä–≤–∏—Å—ã:
- Postgres: –ø–æ—Ä—Ç 5432
- Kafka: –ø–æ—Ä—Ç 9092
- Wiremock: –ø–æ—Ä—Ç 8082
- Payment Backend: –ø–æ—Ä—Ç 8080
- Payment Balance Service: –ø–æ—Ä—Ç 8081

## Flow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö—Ä–∞—Ç–∫–∞—è —Å—Ö–µ–º–∞:**
```
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–ª–∞–Ω—Å–∞ ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ ‚Üí
Kafka (hold-request) ‚Üí Balance –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí Kafka (hold-response) ‚Üí
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí HTTP callback ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç
```

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **payment-backend** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- **–¢–∏–ø:** HTTP ‚Üí DB
- **URL:** POST /api/auth/register
- **–¢–∞–±–ª–∏—Ü–∞:** `payment_db.users` (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

### 2. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–ª–∞–Ω—Å–∞
- –ú–æ–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–ö–æ–º–∏—Å—Å–∏—è:** –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –≤ –∫–æ–¥–µ - 1% (`COMMISSION_RATE = BigDecimal("0.01")`)
- **–†–∞—Å—á–µ—Ç:** `commission = amount * 0.01` (–≤ BalanceService.calculateCommission())
- **–¢–∏–ø:** DB
- **–¢–∞–±–ª–∏—Ü–∞:** `balance_db.balances`
- **–û–ø–µ—Ä–∞—Ü–∏—è:** INSERT/UPDATE balance –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ (–Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å = 0.00)

### 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –ö–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è –∏ –ø–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:** –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <token>`
- **–¢–∏–ø:** HTTP ‚Üí DB
- **URL:** POST /api/auth/login
- **–¢–∞–±–ª–∏—Ü–∞:** `payment_db.users` (–ø—Ä–æ–≤–µ—Ä–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- **payment-backend** —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `CREATED`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HoldRequest –≤ Kafka
- –°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `PROCESSING`
- **–¢–∏–ø:** HTTP ‚Üí DB ‚Üí KAFKA ‚Üí DB
- **URL:** POST /api/payments
- **–¢–∞–±–ª–∏—Ü–∞:** `payment_db.payments` (—Å—Ç–∞—Ç—É—Å CREATED ‚Üí PROCESSING)
- **–¢–æ–ø–∏–∫:** `payment-hold-request` (–æ—Ç–ø—Ä–∞–≤–∫–∞ HoldRequest)

### 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Balance Service
- **payment-balance-service** –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ Kafka
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é (1% –æ—Ç —Å—É–º–º—ã)
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å: –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ ‚Üí **—Å—Ä–∞–∑—É —Å–ø–∏—Å—ã–≤–∞–µ—Ç** —Å—É–º–º—É + –∫–æ–º–∏—Å—Å–∏—è
- –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HoldResponse —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π
- **–¢–∏–ø:** KAFKA ‚Üí DB ‚Üí DB ‚Üí KAFKA
- **–¢–æ–ø–∏–∫ –≤—Ö–æ–¥—è—â–∏–π:** `payment-hold-request`
- **–¢–∞–±–ª–∏—Ü—ã:** `balance_db.balances` (–ø—Ä–æ–≤–µ—Ä–∫–∞/—Å–ø–∏—Å–∞–Ω–∏–µ), `balance_db.transactions` (–∑–∞–ø–∏—Å—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- **–¢–æ–ø–∏–∫ –∏—Å—Ö–æ–¥—è—â–∏–π:** `payment-hold-response`

### 6. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
- **payment-backend** –ø–æ–ª—É—á–∞–µ—Ç HoldResponse –∏–∑ Kafka
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞: `COMPLETED` –µ—Å–ª–∏ success=true, `FAILED` –µ—Å–ª–∏ success=false
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP callback –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL
- **–¢–∏–ø:** KAFKA ‚Üí DB ‚Üí HTTP
- **–¢–æ–ø–∏–∫:** `payment-hold-response` (–ø–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞)
- **–¢–∞–±–ª–∏—Ü–∞:** `payment_db.payments` (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ COMPLETED/FAILED)
- **HTTP:** callback –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π URL

**–ò—Ç–æ–≥–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î:**
- `payment_db.payments` - —Å—Ç–∞—Ç—É—Å COMPLETED/FAILED
- `balance_db.balances` - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å (—É–º–µ–Ω—å—à–µ–Ω –Ω–∞ —Å—É–º–º—É + –∫–æ–º–∏—Å—Å–∏—è)
- `balance_db.transactions` - –∑–∞–ø–∏—Å—å –æ —Å–ø–∏—Å–∞–Ω–∏–∏

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –∫–æ–º–∏—Å—Å–∏–∏:**
- –ü–ª–∞—Ç–µ–∂: 100.00
- –ö–æ–º–∏—Å—Å–∏—è: 100.00 √ó 1% = 1.00 (–∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –≤ –∫–æ–¥–µ BalanceService)
- –ò—Ç–æ–≥–æ —Å–ø–∏—Å–∞–Ω–æ: 100.00 + 1.00 = 101.00

## –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã

**–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã:**
- `CREATED` - –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω
- `PROCESSING` - –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ balance-service
- `COMPLETED` - —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω
- `FAILED` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ç–∞—Ç—É—Å–∞–º–∏:**
```
CREATED ‚Üí PROCESSING ‚Üí COMPLETED
   ‚Üì           ‚Üì
   ‚Üì           ‚Üì
   ‚Üì      ‚Üí FAILED
   ‚Üì
   ‚Üí FAILED (–ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka)
```

**–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã:**
1. `CREATED ‚Üí PROCESSING` - —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ HoldRequest –≤ Kafka
2. `PROCESSING ‚Üí COMPLETED` - –ø–æ–ª—É—á–µ–Ω HoldResponse —Å success=true
3. `PROCESSING ‚Üí FAILED` - –ø–æ–ª—É—á–µ–Ω HoldResponse —Å success=false
4. `CREATED ‚Üí FAILED` - –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Kafka –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞

**–¢—Ä–∏–≥–≥–µ—Ä—ã callback'–æ–≤:**
- Callback –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ `COMPLETED` –∏–ª–∏ `FAILED`
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ `CREATED` –∏ `PROCESSING`

## –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

```
payment-backend ‚Üí Kafka (hold-request) ‚Üí payment-balance-service
payment-balance-service ‚Üí Kafka (hold-response) ‚Üí payment-backend
payment-backend ‚Üí HTTP callback ‚Üí Wiremock/–≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å
```

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- Postgres: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ë–î payment_db –∏ balance_db
- Kafka: —Ç–æ–ø–∏–∫–∏ payment-hold-request, payment-hold-response

## –°—Ö–µ–º–∞ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

### payment_db (PostgreSQL)

**–¢–∞–±–ª–∏—Ü–∞: users**

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| username | VARCHAR (UNIQUE) | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (3-50 —Å–∏–º–≤–æ–ª–æ–≤) |
| password | VARCHAR | –•–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å (6-100 —Å–∏–º–≤–æ–ª–æ–≤) |
| email | VARCHAR (UNIQUE) | Email –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| enabled | BOOLEAN | –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true) |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| created_by | VARCHAR | –ö—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å |
| updated_by | VARCHAR | –ö—Ç–æ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å |

**–¢–∞–±–ª–∏—Ü–∞: payments**

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–ª–∞—Ç–µ–∂–∞ |
| amount | DECIMAL(19,2) | –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ |
| status | VARCHAR (ENUM) | –°—Ç–∞—Ç—É—Å: CREATED, PROCESSING, COMPLETED, FAILED |
| callback_url | VARCHAR | URL –¥–ª—è callback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |
| user_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| external_id | VARCHAR (UNIQUE) | –í–Ω–µ—à–Ω–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| created_by | VARCHAR | –ö—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å |
| updated_by | VARCHAR | –ö—Ç–æ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å |

**–¢–∞–±–ª–∏—Ü–∞: auth_tokens**

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–∫–µ–Ω–∞ |
| token | VARCHAR (UNIQUE) | JWT —Ç–æ–∫–µ–Ω |
| user_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| expires_at | TIMESTAMP | –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

### balance_db (PostgreSQL)

**–¢–∞–±–ª–∏—Ü–∞: balances**

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–∞–ª–∞–Ω—Å–∞ |
| username | VARCHAR (UNIQUE) | –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| balance | DECIMAL(19,2) | –î–æ—Å—Ç—É–ø–Ω—ã–π –±–∞–ª–∞–Ω—Å |
| reserved_amount | DECIMAL(19,2) | –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| created_by | VARCHAR | –ö—Ç–æ —Å–æ–∑–¥–∞–ª –∑–∞–ø–∏—Å—å |
| updated_by | VARCHAR | –ö—Ç–æ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å |

**–¢–∞–±–ª–∏—Ü–∞: transactions**

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | UUID (PK) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| balance_id | UUID (FK) | –°—Å—ã–ª–∫–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å |
| amount | DECIMAL(19,2) | –°—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| type | VARCHAR (ENUM) | –¢–∏–ø: DEPOSIT, WITHDRAWAL, HOLD, RELEASE |
| payment_id | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–ª–∞—Ç–µ–∂ (–º–æ–∂–µ—Ç –±—ã—Ç—å null) |
| status | VARCHAR (ENUM) | –°—Ç–∞—Ç—É—Å: PENDING, COMPLETED, FAILED |
| created_at | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| updated_at | TIMESTAMP | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

## API —Å–µ—Ä–≤–∏—Å–æ–≤

### Payment Backend (–ø–æ—Ä—Ç 8080)

**–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
```json
POST /api/auth/register
{
  "username": "user1",
  "password": "password123"
}
```

**–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
```json
POST /api/auth/login
{
  "username": "user1",
  "password": "password123"
}
```

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
```json
POST /api/payments
Authorization: Bearer <token>
{
  "amount": 100.50,
  "callbackUrl": "http://wiremock:8080/payment/callback"
}
```

**–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
```
GET /api/payments/{id}
```

**Callback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
```json
POST {callbackUrl}
Content-Type: application/json

{
  "paymentId": "uuid",
  "status": "COMPLETED", // –∏–ª–∏ "FAILED"
  "amount": 100.50,
  "commission": 1.00, // —Ç–æ–ª—å–∫–æ –ø—Ä–∏ success (1% –æ—Ç —Å—É–º–º—ã)
  "timestamp": "2025-09-20T13:50:00",
  "message": "–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω" // –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
}
```
- **callbackUrl** –±–µ—Ä–µ—Ç—Å—è –∏–∑ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞—Ç—É—Å–∞—Ö `COMPLETED` –∏–ª–∏ `FAILED`
- Timeout: 30 —Å–µ–∫—É–Ω–¥
- Retry: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥
- –û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç 200-299 –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è

### Kafka —Å–æ–æ–±—â–µ–Ω–∏—è

**–¢–æ–ø–∏–∫: payment-hold-request**
**Hold Request:**
```json
{
  "paymentId": "uuid",
  "userId": "username",
  "amount": 100.50
}
```

**–¢–æ–ø–∏–∫: payment-hold-response**
**Hold Response:**
```json
{
  "paymentId": "uuid",
  "success": true,
  "message": "–£—Å–ø–µ—à–Ω–æ —Å–ø–∏—Å–∞–Ω–æ",
  "commission": 1.00
}
```

## –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–∏—Å–∞–º

**–í–Ω–µ—à–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Å —Ö–æ—Å—Ç–∞):**

**HTTP API —Å–µ—Ä–≤–∏—Å–æ–≤:**
- Payment Backend: `http://localhost:8080`
- Payment Balance Service: `http://localhost:8081` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π, –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ API)
- Wiremock: `http://localhost:8082`

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
```bash
psql -h localhost -p 5432 -U postgres -d postgres
# –ó–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ë–î:
\c payment_db;
\c balance_db;
```

**Kafka (—Å —Ö–æ—Å—Ç–∞):**
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Kafka —á–µ—Ä–µ–∑ localhost:9092
kafka-console-consumer --bootstrap-server localhost:9092 --topic payment-hold-request --from-beginning
kafka-console-producer --bootstrap-server localhost:9092 --topic payment-hold-request
```

**Kafka:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–ø–∏–∫–æ–≤
docker exec -it kafka kafka-topics --bootstrap-server localhost:9092 --list

# –ß—Ç–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
docker exec -it kafka kafka-console-consumer --bootstrap-server localhost:9092 --topic payment-hold-request --from-beginning
```

**Wiremock Admin API:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–≥–ª—É—à–µ–∫
GET http://localhost:8082/__admin/mappings

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ callback'–æ–≤)
GET http://localhost:8082/__admin/requests

# –ü–æ–∏—Å–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ URL
GET http://localhost:8082/__admin/requests?url=/payment/callback

# –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
DELETE http://localhost:8082/__admin/requests

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
GET http://localhost:8082/__admin/requests/{request-id}
```

**HTTP API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (–∏–∑ Python/–ª—é–±–æ–≥–æ —è–∑—ã–∫–∞):**
```bash
# –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
GET http://localhost:8082/__admin/requests

# –ü–æ–¥—Å—á–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
POST http://localhost:8082/__admin/requests/count
{
  "method": "POST",
  "url": "/payment/callback"
}

# –ü–æ–∏—Å–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
POST http://localhost:8082/__admin/requests/find
{
  "method": "POST",
  "urlPath": "/payment/callback",
  "headers": {
    "Content-Type": {"equalTo": "application/json"}
  }
}

# –ù–µ–æ—Ç–ª–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
GET http://localhost:8082/__admin/requests/unmatched
```

## Wiremock –∑–∞–≥–ª—É—à–∫–∏

**Health check:**
- `GET /health` ‚Üí —Å—Ç–∞—Ç—É—Å UP

**–£—Å–ø–µ—à–Ω—ã–π callback:**
- `POST /payment/callback` ‚Üí 200 OK, status: SUCCESS

**–ù–µ—É—Å–ø–µ—à–Ω—ã–π callback:**
- `POST /payment/callback/failure` ‚Üí 200 OK, status: FAILED, errorCode: INSUFFICIENT_FUNDS

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö callback'–æ–≤:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Wiremock
curl http://localhost:8082/__admin/requests | jq '.requests[]'

# –ü–æ–∏—Å–∫ callback'–æ–≤ –ø–æ URL
curl "http://localhost:8082/__admin/requests?url=/payment/callback" | jq '.requests[].request.body'
```

–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö: timestamp, transactionId –∏–∑ –∑–∞–ø—Ä–æ—Å–∞, processingTime (100-5000ms).

**üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è WireMock Admin API:**
https://wiremock.org/docs/verifying/ - –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

## –û—à–∏–±–∫–∏

**401 (Unauthorized):**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization`
- –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ (`Bearer <token>`)
- –ò—Å—Ç–µ–∫—à–∏–π –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π JWT —Ç–æ–∫–µ–Ω
- –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (POST /api/auth/login)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

**400 (Bad Request):**

*–ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (POST /api/auth/register):*
- `username`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –¥–ª–∏–Ω–∞ 3-50 —Å–∏–º–≤–æ–ª–æ–≤
- `password`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –¥–ª–∏–Ω–∞ 6-100 —Å–∏–º–≤–æ–ª–æ–≤
- `email`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π email —Ñ–æ—Ä–º–∞—Ç

*–ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (POST /api/auth/login):*
- `username`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ
- `password`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ

*–ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (POST /api/payments):*
- `amount`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –º–∏–Ω–∏–º—É–º 0.01 (–±–æ–ª—å—à–µ –Ω—É–ª—è)
- `callbackUrl`: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ, –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

*–î—Ä—É–≥–∏–µ –ø—Ä–∏—á–∏–Ω—ã 400:*
- –ù–µ–≤–µ—Ä–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
- `IllegalArgumentException` –∏–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ email/username –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

**404 (Not Found):**
- –ü–ª–∞—Ç–µ–∂ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω (GET /api/payments/{id})

**500 (Internal Server Error):**
- –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- –û—à–∏–±–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î –∏–ª–∏ Kafka
- –ü—Ä–æ—á–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏